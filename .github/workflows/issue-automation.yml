name: Issue Management Automation

on:
  issues:
    types: [opened, labeled]

permissions:
  issues: write
  contents: read

jobs:
  issue-triage:
    runs-on: ubuntu-latest
    if: github.event.action == 'opened' || (github.event.action == 'labeled' && !contains(github.event.label.name, 'priority') && !contains(github.event.label.name, 'needs'))
    steps:
      - name: Manage Labels and Triage
        uses: actions/github-script@v7
        with:
          script: |
            if (context.actor === 'github-actions[bot]') return;

            const issue = context.payload.issue;
            const title = issue.title.toLowerCase();
            const body = (issue.body || '').toLowerCase();
            const { owner, repo } = context.repo;

            // 1. Ensure Labels Exist
            const requiredLabels = [
              { name: 'bug', color: 'd73a4a', description: 'Something isn\'t working' },
              { name: 'enhancement', color: 'a2eeef', description: 'New feature or request' },
              { name: 'epic', color: '3E4B9E', description: 'Large feature requiring multiple sub-tasks' },
              { name: 'maintenance', color: 'fbca04', description: 'Maintenance and housekeeping tasks' },
              { name: 'priority-critical', color: 'b60205', description: 'Critical priority issue' },
              { name: 'priority-high', color: 'd93f0b', description: 'High priority issue' },
              { name: 'priority-medium', color: '0e8a16', description: 'Medium priority issue' },
              { name: 'priority-low', color: 'c2e0c6', description: 'Low priority issue' },
              { name: 'needs-triage', color: 'f9d0c4', description: 'Needs to be reviewed by maintainers' },
              { name: 'needs-review', color: 'fef2c0', description: 'Awaiting review from maintainers' },
              { name: 'first-time-contributor', color: '7057ff', description: 'Issue created by first-time contributor' }
            ];

            const existingLabels = await github.paginate(github.rest.issues.listLabelsForRepo, {
              owner,
              repo
            });
            const existingNames = new Set(existingLabels.map(l => l.name));

            for (const label of requiredLabels) {
              if (!existingNames.has(label.name)) {
                await github.rest.issues.createLabel({
                  owner,
                  repo,
                  name: label.name,
                  color: label.color,
                  description: label.description
                });
              }
            }

            // 2. Auto-assign Category
            const labelsToAdd = [];
            const currentLabels = issue.labels.map(l => l.name);

            if (title.includes('bug') && !currentLabels.includes('bug')) labelsToAdd.push('bug');
            if (title.includes('epic') && !currentLabels.includes('epic')) labelsToAdd.push('epic');
            if (title.includes('maintenance') && !currentLabels.includes('maintenance')) labelsToAdd.push('maintenance');

            // 3. Auto-assign Priority
            let priority = 'priority-medium';
            if (['critical', 'urgent', 'production', 'outage'].some(w => title.includes(w) || body.includes(w))) priority = 'priority-critical';
            else if (['important', 'high', 'blocking'].some(w => title.includes(w) || body.includes(w))) priority = 'priority-high';
            else if (['medium', 'normal'].some(w => title.includes(w) || body.includes(w))) priority = 'priority-medium';
            else if (['low', 'nice-to-have', 'minor'].some(w => title.includes(w) || body.includes(w))) priority = 'priority-low';

            if (!currentLabels.includes(priority)) {
                labelsToAdd.push(priority);
            }

            // 4. Add needs-triage
            if (!currentLabels.includes('needs-triage')) {
                labelsToAdd.push('needs-triage');
            }

            if (labelsToAdd.length > 0) {
              await github.rest.issues.addLabels({
                owner,
                repo,
                issue_number: issue.number,
                labels: labelsToAdd
              });
            }

  task-breakdown:
    needs: issue-triage
    runs-on: ubuntu-latest
    if: github.event.action == 'opened' && contains(github.event.issue.title, 'Epic')
    steps:
      - name: Create Sub-tasks
        uses: actions/github-script@v7
        with:
          script: |
            if (context.actor === 'github-actions[bot]') return;
            
            const issue = context.payload.issue;
            const title = issue.title;
            const { owner, repo } = context.repo;

            const tasks = [
                "Requirements Analysis",
                "Design and Architecture",
                "Implementation",
                "Testing and Documentation"
            ];
            
            let checklist = "\n## Epic Tasks\n";
            
            for (let i = 0; i < tasks.length; i++) {
                const taskName = tasks[i];
                const subTitle = `[SUBTASK] ${title} - Task ${i+1}: ${taskName}`;
                const subBody = `Related to #${issue.number}`;
                
                const subIssue = await github.rest.issues.create({
                    owner,
                    repo,
                    title: subTitle,
                    body: subBody,
                    labels: ['enhancement', 'needs-review']
                });
                
                checklist += `- [ ] #${subIssue.data.number} ${taskName}\n`;
            }
            
            await github.rest.issues.update({
                owner,
                repo,
                issue_number: issue.number,
                body: (issue.body || '') + checklist
            });

  auto-response:
    needs: issue-triage
    runs-on: ubuntu-latest
    if: github.event.action == 'opened'
    steps:
      - name: Auto Response and Cleanup
        uses: actions/github-script@v7
        with:
          script: |
            if (context.actor === 'github-actions[bot]') return;

            const issue = context.payload.issue;
            const { owner, repo } = context.repo;

            // 1. First time contributor
            const userIssues = await github.rest.issues.listForRepo({
                owner,
                repo,
                creator: issue.user.login,
                state: 'all',
                per_page: 2
            });
            
            if (userIssues.data.length === 1) {
                await github.rest.issues.addLabels({
                    owner,
                    repo,
                    issue_number: issue.number,
                    labels: ['first-time-contributor']
                });
                await github.rest.issues.createComment({
                    owner,
                    repo,
                    issue_number: issue.number,
                    body: `Welcome @${issue.user.login}! Thanks for opening your first issue here.`
                });
            }

            // 2. Response based on labels
            const { data: currentIssue } = await github.rest.issues.get({
                owner,
                repo,
                issue_number: issue.number
            });
            
            const labels = currentIssue.labels.map(l => l.name);
            let commentBody = "";
            
            if (labels.includes('bug')) {
                commentBody += "## Bug Report Guidelines\nPlease ensure you have provided reproduction steps.\n\n";
            }
            if (labels.includes('epic')) {
                commentBody += "## Feature Request Process\nThis epic will be broken down into subtasks.\n\n";
            }
            if (labels.includes('maintenance')) {
                commentBody += "## Maintenance Guidelines\nThanks for keeping the code clean.\n\n";
            }
            
            if (commentBody) {
                await github.rest.issues.createComment({
                    owner,
                    repo,
                    issue_number: issue.number,
                    body: commentBody.trim()
                });
            }

            // 3. Set Milestone
            if (labels.includes('priority-high') || labels.includes('priority-critical')) {
                const milestones = await github.rest.issues.listMilestones({
                    owner,
                    repo,
                    state: 'open'
                });
                let milestone = milestones.data.find(m => m.title === 'v1.0.0');
                if (!milestone) {
                    milestone = (await github.rest.issues.createMilestone({
                        owner,
                        repo,
                        title: 'v1.0.0'
                    })).data;
                }
                await github.rest.issues.update({
                    owner,
                    repo,
                    issue_number: issue.number,
                    milestone: milestone.number
                });
            }

            // 4. Change Status
            if (labels.includes('needs-triage')) {
                try {
                  await github.rest.issues.removeLabel({
                      owner,
                      repo,
                      issue_number: issue.number,
                      name: 'needs-triage'
                  });
                } catch (e) {
                  // Ignore if label not present
                  console.log('needs-triage label not found or already removed');
                }
                
                await github.rest.issues.addLabels({
                    owner,
                    repo,
                    issue_number: issue.number,
                    labels: ['needs-review']
                });
            }
